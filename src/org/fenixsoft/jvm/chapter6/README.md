## 类文件结构

### 无关性的基石

各种不同平台的Java虚拟机，以及所有平台都统一支持的程序存储格式——字节码 是构成<u>平台无关性</u>的基石。  
虚拟机也有另外一种中立特性——<u>语言无关性</u>。实现语言无关性的基础仍然是虚拟机和字节码存储格式。 Java虚拟机不与包括Java语言在内的任何程序语言绑定，它只与Class文件这种特定的二进制文件格式所关联，Class文件中包含了Java虚拟机指令集、符号表以及若干其他辅助信息。  
Java语言中的各种语法、关键字、常量变量和运算符号的语义最终都会由多条字节码指令组合来表达，这决定了字节码指令所能提供的语言描述能力必须比Java语言本身更加强大才行。 因此有一些Java语言本身无法有效支持的语言特性并不代表在字节码中也无法有效表达出来，这为其他程序语言实现一些有别于Java的语言特性提供了发挥空间。

### Class类文件的结构

任何一个Class文件都对应着唯一的一个类或接口定义的信息，但是反过来说，类或接口并不一定都得定义在文件里（也可以动态生成）  
Class文件是一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地列在文件中，中间没有添加任何分隔符。当遇到需要占用8位以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。

根据《Java虚拟机规范》，Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种伪结构只有两种数据类型：无符号数和表

* 无符号数属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节、8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成的字符串值。
* 表是由多个无符号数或者其他表作为数据项构成的复合数据类型，为了便于区分以 ”_info“结尾。表用于描述有层次关系的复合结构的数据，整个Class文件本质上也可以视为一张表。

无论是无符号数还是表，当需要描述同一类型但数量不定的多个数据时，经常会使用一个前置的容量计数器加若干个连续的数据项的形式，这时候称这一系列连续的某一类型的数据为某一类型的集合。参考下表中的constant_pool_count

|类型|名称|数量|说明|  
|---|---|---| ---| 
|u4|magic|1|每个Class文件的头4个字节被称为魔数，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。值为OxCAFFBABE。|
|u2|minor_version|1|次版本号，从JDK1.2到JDK12之前均未再使用，全部固定为0.到了JDK12，由于JDK提供的功能已经非常庞大，有一些复杂的新特性需要以公测的形式放出，被设计者重新启用，用于标识技术预览版功能特性的支持。|
|u2|major_version|1|主版本号，Java的版本号是从45开始的，JDK1.1以后每个大版本发布，主版本号+1.高版本的JDK能向下兼容以前版本的Class文件，但不能运行以后版本的Class文件。|
|u2|constant_pool_count|1|常量池容量计数值，代表常量池中有 <u>计数值-1</u> 项常量,设计者将第0型常量空出来，如果后面某些指向常量池的索引值的数据在特定情况下需要表达“不引用任何一个常量池项目”的含义，可以把索引值设置为0来表示。|
|cp_info|**constant_pool**|constant_pool_count-1|常量池可以比喻为Class文件里的资源仓库，它是Class文件结构中与其他项目关联最多的数据，通常也是占用Class文件空间最大的数据项目之一，还是Class文件中第一个出现的表类型数据项目。常量池中每一项常量都是一个表，表结构起始的第一位是个u1类型的标志位，代表当前常量属于哪种类型。|
|u2|access_flags|1|访问标志用于识别一些类或者接口层次的访问信息。这个Class是类还是接口；是否定义为public类型；是否定义为abstract类型；如果是类的话，是否声明未final等。|
|u2|this_class|1|类索引用于确定这个类的全限定名|
|u2|super_class|1|父类索引用于确定这个类的父类的全限定名|
|u2|interfaces_count|1|接口计数器表示索引表的容量。如果该类没有实现任何接口，则该计数器值为0，后面接口索引表不再占用任何字节。|
|u2|interfaces|interfaces_count||
|u2|fields_count|1|容量计数器说明这个类有多少个字段表数据。|
|field_info|**fields**|fields_count|字段表用于描述接口或者类中声明的变量。Java语言中的字段包括类级变量以及实例变量，但不包括在方法内部声明的局部变量。|
|u2|methods_count|1|容量计数器代表集合中有多少个方法。|
|method_info|**methods**|methods_count|Class文件存储格式中对方法的描述与对字段的描述采用了几乎完全一致的方式。|
|u2|attributes_count|1|容量计数器代表集合中有多少个属性|
|attribute_info|**attributes**|attributes_count|Class文件、字段表、方法表都可以携带自己的属性表集合，以描述某些场景专有的信息|

#### 常量池

#### 访问标志

#### 字段表集合

#### 方法表集合

#### 属性表集合
