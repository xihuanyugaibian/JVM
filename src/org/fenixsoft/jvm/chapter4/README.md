给一个系统定位问题的时候，知识、经验是关键基础，数据是依据，工具是运用知识处理数据的手段。  
恰当地使用虚拟机故障处理、分析的工具可以提升我们分析数据、定位并解决问题的效率，也应当意识到工具永远都是知识技能的一层包装，没有什么工具是秘密武器，拥有了就能包治百病。

## 基础故障处理工具

JDK的bin目录下有很多小工具，除了编译和运行Java程序外，打包、部署、签名、调试、监控、运维等各种场景都可能会用到它们。  
这些工具体积基本上都稳定在21KB左右，其实这些命令行工具大多仅是一层薄包装，真正的功能代码是实现在JDK的工具类库中。

### jps：虚拟机进程状况工具

列出正在运行的虚拟机进程，并显示虚拟机执行主类名称以及这些进程的本地虚拟机唯一ID（LVMID：Local Virtual Machine
Identifier）。对于本地虚拟机进程来说，LVMID与操作系统的进行ID是一致的。  
常用命令

* jps -l：输出主类的全名，如果进程是JAR包，则输出JAR路径
* jps -v：输出虚拟机进程启动时的JVM参数
* jps -m：输出虚拟机进程启动时传递给主类main函数的参数

### jstat：虚拟机统计信息监视工具

用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类加载、内存、垃圾收集、即时编译器等运行时数据。

jstat [option vmid [interval [s|ms] [count]]]  
如果是本地虚拟机进程VMID与LVMID是一致的，如果是远程虚拟机那VMID是[protocol:][//]lvmid[@hostname[:port]/servername]

* interval：查询间隔默认ms
* count：查询次数
* option代表用户希望查询的虚拟机信息 主要分为类加载、垃圾收集、运行期编译状况。（具体命令用时查询）

### jinfo：Java配置信息工具

实时查看和调整虚拟机各项参数。注意jinfo工具所在的jdk最好和运行Java程序的jdk是同一个。不然有些命令可能会执行出错。

jinfo -h：查看命令帮助，有详细介绍。

### jmap：Java内存映像工具

用于生成堆转储快照，还可以查询finalize执行队列、Java堆和方法区的详细信息（空间使用率，当前使用哪种收集器）

jmap -h：查看命令帮助，有详细介绍。

### jhat：虚拟机堆转储快照分析工具

与jmap搭配使用，来分析jmap生成的堆转出快照，实际工作中很少用。

### jstack：Java堆栈跟踪工具

生成虚拟机当前时刻的线程快照。  
线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的目的通常是定位线程出现长时间停顿的原因。

java.lang.Thread类新增一个getAllStackTraces方法用于获取虚拟机中所有线程的StackTraceElement对象，在实际项目中可以在管理员页面中调用这个方法以便查看线程堆栈。

## 可视化故障处理工具
主要有Jconsole，JHSDB，VisualVM，JMC四个。  
Jconsole和JHDSDB随着JDK一同发布，不需要独立下载，可以直接使用。

### JHSDB：基于服务性代理的调试工具

名义上JDK9才正式提供，是一款基于服务性代理实现的进程外调试工具。  
服务性代理是HotSpot虚拟机中一组用于映射Java虚拟机运行信息的、主要基于Java语言实现的API集合。  
服务性代理以HotSpot内部的数据结构位参照物进行设计，把这些C++数据抽象出Java模型对象，相当于HotSpot的C++代码的一个镜像。  
通过服务性代理的API，可以在一个独立的Java虚拟机的进程里分析其他HotSpot虚拟机的内部数据。

1. 运行org.fenixsoft.jvm.chapter4.JHSDBTestCase.main方法，注意提前打断点。启动后通过 jps -l 查询进程id
2. jhsdb hsdb --pid 进程id：通过该命令进入JHSDB的图形化模式
3. 点击菜单中 Tools->Heap Parameters 查看收集器内存地址范围
4. 点击菜单Windows->Console 使用 **scanoops 起始地址 终止地址 包命.类名$变量名** 查询变量所在的地址
5. 点击菜单 Tools->Inspector 输入4中的变量地址查看地址中存放的对象。  
   Inspector展示对象头和指向对象元数据的指针（Java类型的名字、继承关系、实现接口关系、字段信息、方法信息、运行时常量池的指针、内嵌的虚方法表、接口方法表等）
6. 通过console 使用 **revptrs 4中的地址**查看引用该对象地方，该命令不支持查找栈上的指针引用。  
   也可以点击5中的Inspector界面下面的Compute Liveness 此时Inspector界面除了对象头和指向对象元数据的指针会多一行《Revers pointers》猜测应该时引用该对象的地方。  
   点击Compute Liveness之后，好像是程序界面的开发有问题，只能展开查看Revers pointers，指向对象元数据的指针就无法展开查看了。

从《Java虚拟机规范》所定义的模型来看，所有Class相关的信息都应该存放在方法区之中，但是方法区该如何实现并未做出规定，这就成了一件允许不同虚拟机自己灵活把握的事情。
JDK7及其以后版本的HotSpot虚拟机选择把静态变量与类型在Java一端的映射Class对象存放在一起，存储在Java堆之中。即**方法区的实现实在堆中**

### JConsole：Java监视与管理控制台

是一款基于JMX(Java Management Extensions)的可视化监视、管理工具 。它的主要功能是通过JMX的MBean对系统进行信息收集和参数动态调整。  
JMX是一种开放性的技术，不仅可以用来虚拟机本身的管理上，还可以运行于虚拟机之上的软件中。  
虚拟机对JMX MBean的访问也是完全开放的，可以使用代码调用API、支持JMX协议的管理控制台，或者其他符合JMX规范的软件进行访问。

### VisualVM:多合一故障处理工具

[VisualVM下载](https://visualvm.github.io/)  
VisualVM是功能最强大的运行监视和故障处理程序之一，不需要被监视的程序基于特殊Agent去运行，因此它的通用性很强，对应用程序实际性能影响也比较小，使得它可以直接应用在生产环境中。  
Idea有 VisualVM启动器插件，当电脑本地安装了VisualVM时，通过插件指定后，在开发过程中，可以以有VisualVM的debug模式启动程序，进而监控程序的状态。

### Java Mission Control：可持续在线的监控工具

Oracle公司还开辟过带商业技术支持的Oracle Java SE Support和面向独立软件供应商的Oracle Java SE Advanced & Suite。  
Oracle Java SE Advanced & Suite与普通的Oracle Java SE在功能上的主要差别是前者包含了一系列的监控、管理工具，
譬如用于企业JRE定制管理的AMC控制台、JUT跟踪系统、用于持续收集数据的JFR飞行记录仪、用于监控Java虚拟机的JMC。 这些功能需要商业授权才能在生产环境中使用，但**根据Oracle Binary
Code协议，在个人开发环境中，允许使用JMC和JFR。**

## HotSpot虚拟机插件及工具

### HSDIS：JIT生成代码反汇编

在《Java虚拟机规范》里详细定义了虚拟机指令集总每条指令的语义，尤其是执行过程前后对操作数栈，局部变量表的影响。  
这些细节描述与早期的Java虚拟机高度吻合，随着技术的发展，高性能虚拟机真正的细节实现方式与描述内容的偏差越来远大，
《Java虚拟机规范》中的规定逐渐成为Java虚拟机实现的“概念模型”，即实现只保证与规范描述等效，而不一定是按照规范描述去执行。  
由于这个原因，在讨论程序的执行语义问题（虚拟机做了什么）时，在字节码层面上分析完全可行，但讨论程序的执行行为问题（虚拟机是怎样做的）时，在字节码层面上分析就没有意义。

HSDIS是一个被官方推荐的HotSpot虚拟机即时编译代码的反汇编插件，它包含在HotSpot虚拟机的源码当中。  
HSDIS插件的作用是让HotSpot的-XX:+PrintAssembly指令调用它来吧即时编译器动态生成的本地代码还原为汇编代码输出，同时还会产生大量非常有价值的注释，这样就可以通过输出的汇编代码来从最本质的角度分析问题。

JITWatch：是HSDIS经常搭配使用的可视化编译日志分析工具。

## 本章小结

介绍了6个命令行工具和4个可视化故障处理工具。 但是这些工具只是简单的了解了一下，怎么拿来去分析程序解决问题还是不知道。

