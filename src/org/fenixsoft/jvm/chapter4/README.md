给一个系统定位问题的时候，知识、经验是关键基础，数据是依据，工具是运用知识处理数据的手段。  
恰当地使用虚拟机故障处理、分析的工具可以提升我们分析数据、定位并解决问题的效率，也应当意识到工具永远都是知识技能的一层包装，没有什么工具是秘密武器，拥有了就能包治百病。

## 基础故障处理工具

JDK的bin目录下有很多小工具，除了编译和运行Java程序外，打包、部署、签名、调试、监控、运维等各种场景都可能会用到它们。  
这些工具体积基本上都稳定在21KB左右，其实这些命令行工具大多仅是一层薄包装，真正的功能代码是实现在JDK的工具类库中。

### jps：虚拟机进程状况工具

列出正在运行的虚拟机进程，并显示虚拟机执行主类名称以及这些进程的本地虚拟机唯一ID（LVMID：Local Virtual Machine
Identifier）。对于本地虚拟机进程来说，LVMID与操作系统的进行ID是一致的。  
常用命令

* jps -l：输出主类的全名，如果进程是JAR包，则输出JAR路径
* jps -v：输出虚拟机进程启动时的JVM参数
* jps -m：输出虚拟机进程启动时传递给主类main函数的参数

### jstat：虚拟机统计信息监视工具

用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类加载、内存、垃圾收集、即时编译器等运行时数据。

jstat [option vmid [interval [s|ms] [count]]]  
如果是本地虚拟机进程VMID与LVMID是一致的，如果是远程虚拟机那VMID是[protocol:][//]lvmid[@hostname[:port]/servername]

* interval：查询间隔默认ms
* count：查询次数
* option代表用户希望查询的虚拟机信息 主要分为类加载、垃圾收集、运行期编译状况。（具体命令用时查询）

### jinfo：Java配置信息工具

实时查看和调整虚拟机各项参数。注意jinfo工具所在的jdk最好和运行Java程序的jdk是同一个。不然有些命令可能会执行出错。

jinfo -h：查看命令帮助，有详细介绍。

### jmap：Java内存映像工具

用于生成堆转储快照，还可以查询finalize执行队列、Java堆和方法区的详细信息（空间使用率，当前使用哪种收集器）

jmap -h：查看命令帮助，有详细介绍。

### jhat：虚拟机堆转储快照分析工具

与jmap搭配使用，来分析jmap生成的堆转出快照，实际工作中很少用。

### jstack：Java堆栈跟踪工具

生成虚拟机当前时刻的线程快照。  
线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的目的通常是定位线程出现长时间停顿的原因。

java.lang.Thread类新增一个getAllStackTraces方法用于获取虚拟机中所有线程的StackTraceElement对象，在实际项目中可以在管理员页面中调用这个方法以便查看线程堆栈。

## 可视化故障处理工具

### JHSDB：基于服务性代理的调试工具

名义上JDK9才正式提供，是一款基于服务性代理实现的进程外调试工具。  
服务性代理是HotSpot虚拟机中一组用于映射Java虚拟机运行信息的、主要基于Java语言实现的API集合。  
服务性代理以HotSpot内部的数据结构位参照物进行设计，把这些C++数据抽象出Java模型对象，相当于HotSpot的C++代码的一个镜像。  
通过服务性代理的API，可以在一个独立的Java虚拟机的进程里分析其他HotSpot虚拟机的内部数据。

1. 运行org.fenixsoft.jvm.chapter4.JHSDBTestCase.main方法，注意提前打断点。启动后通过 jps -l 查询进程id
2. jhsdb hsdb --pid 进程id：通过该命令进入JHSDB的图形化模式
3. 点击菜单中 Tools->Heap Parameters 查看收集器内存地址范围
4. 点击菜单Windows->Console 使用 **scanoops 起始地址 终止地址 包命.类名$变量名** 查询变量所在的地址
5. 点击菜单 Tools->Inspector 输入4中的变量地址查看地址中存放的对象。  
   Inspector展示对象头和指向对象元数据的指针（Java类型的名字、继承关系、实现接口关系、字段信息、方法信息、运行时常量池的指针、内嵌的虚方法表、接口方法表等）
6. 通过console 使用 **revptrs 4中的地址**查看引用该对象地方，该命令不支持查找栈上的指针引用。  
   也可以点击5中的Inspector界面下面的Compute Liveness 此时Inspector界面除了对象头和指向对象元数据的指针会多一行《Revers pointers》猜测应该时引用该对象的地方。  
   点击Compute Liveness之后，好像是程序界面的开发有问题，只能展开查看Revers pointers，指向对象元数据的指针就无法展开查看了。

从《Java虚拟机规范》所定义的模型来看，所有Class相关的信息都应该存放在方法区之中，但是方法区该如何实现并未做出规定，这就成了一件允许不同虚拟机自己灵活把握的事情。
JDK7及其以后版本的HotSpot虚拟机选择把静态变量与类型在Java一端的映射Class对象存放在一起，存储在Java堆之中。即**方法区的实现实在堆中**

### JConsole：Java监视与管理控制台

### VisualVM:多合一故障处理工具
[VisualVM下载](https://visualvm.github.io/)

